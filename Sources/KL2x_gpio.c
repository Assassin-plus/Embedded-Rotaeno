/***********************************************************
 * ?????       ??KL25_gpio.c
 * ???         ??IO??????????
 * ????         ??landzo ??????
 * ?????       ??http://landzo.taobao.com/
 * ??????     ??http://www.landzo.com/
 *???          ??http://www.landzo.cn
 *????        ??V1.0
 *???          ??15.5.26
************************************************************/
/*
 * ????????
 */
#include "derivative.h" /* include peripheral declarations */
#include "KL2x_gpio.h"



//?????????????????????PORTX[0]~PORTX[4]??
volatile struct PORT_MemMap *PORTX[5]={PORTA_BASE_PTR, PORTB_BASE_PTR, PORTC_BASE_PTR, PORTD_BASE_PTR, PORTE_BASE_PTR};
//GPIO??????????????????GPIOx[0]~GPIOx[4]??
volatile struct GPIO_MemMap *GPIOX[5]={PTA_BASE_PTR, PTB_BASE_PTR, PTC_BASE_PTR, PTD_BASE_PTR, PTE_BASE_PTR};
/*************************************************************************
*                             ???????????????
*
*  ?????????gpio_enable_port
*  ?????????????????GPIO???????? ???????????????
*  ?????????
*  ???????????
*  ??????2015-5-15   ?????
*  ??    ???????????????
*************************************************************************/
void gpio_enable_port (void)
{
 	  SIM_SCGC5 |=   SIM_SCGC5_PORTA_MASK \
	               | SIM_SCGC5_PORTB_MASK \
	               | SIM_SCGC5_PORTC_MASK \
	               | SIM_SCGC5_PORTD_MASK \
	               | SIM_SCGC5_PORTE_MASK;
}
/*************************************************************************
*                             ???????????????
*
*  ?????????gpio_Interrupt_init
*  ??????????????GPIO?????
*  ?????????PTxn        ????
*            GPIO_CFG    ?????
*            mode        ?????? 
*  ???????????
*  ??????2015-5-15   ?????
*  ??    ???
*************************************************************************/

void gpio_Interrupt_init(PTxn ptxn, GPIO_CFG cfg, unsigned long mode)
{
  //unsigned short altcfg ;
  if((cfg == GPI)||(cfg == GPI_DOWN)||(cfg == GPI_UP))
  {
    //altcfg = ptxn>> 5 ; 
   // cfg |= (cfg | (ALT1 + mode)) ;
    Port_init(ptxn,(cfg | ALT1 | mode));
   // PORT_PCR_REG(PORTX[ptxn>>5],(ptxn&0x1f)) = (0 | cfg | ALT1 | mode);
    //PORT_PCR_REG(PORTX_BASE(ptxn), PTn(ptxn)) = (0 | PORT_PCR_MUX(1) | cfg | mode);
    GPIO_PDDR_REG(GPIOX[ptxn>> 5]) &= ~(1 << (ptxn&0x1f));  //?????????????? 
#if defined(MKL25Z4)
    if(PTX(ptxn)==0) enable_irq(PortA_irq_no);
    else if(PTX(ptxn)==3) enable_irq(PortD_irq_no);
#elif defined(MKL26Z4)
    if(PTX(ptxn)==0) enable_irq(PortA_irq_no);
    else if((PTX(ptxn)==2)||(PTX(ptxn)==3)) enable_irq(PortC_PortD_irq_no);
#endif
  }
}

/*************************************************************************
*                             ???????????????
*
*  ?????????gpio_init
*  ??????????????gpio
*  ?????????PTxn        ????
*            GPIO_CFG    ?????
*            unsigned short       ????????? 1 ??0
*  ???????????
*  ??????2015-5-15   ?????
*  ??    ???
*************************************************************************/
void gpio_init (PTxn ptxn, GPIO_CFG cfg, unsigned short sata)
{ 
//??????????????????
    if( (cfg  == GPI) || (cfg == GPI_UP) || (cfg == GPI_DOWN) )
    {
       Port_init(ptxn,cfg|ALT1);
       GPIO_PDDR_REG(GPIOX[ptxn>> 5]) &= ~(1 << (ptxn&0x1f));  //?????????????? 
    }
    else
    {  
        Port_init(ptxn,ALT1) ;  
      //?????????????
        GPIO_PDDR_REG(GPIOX[ptxn>> 5]) |= (1 << (ptxn&0x1f));        // GPIO PDDR ???? ??1????????????????????????
        //??????????/        
        if(sata == 0){     
            GPIO_PDOR_REG(GPIOX[ptxn>> 5]) &= ~(1 << (ptxn&0x1f));   // GPIO PDOR ???? ??0?????????????????????????
         }else{
            GPIO_PDOR_REG(GPIOX[ptxn>> 5])  |= (1 << (ptxn&0x1f));   // GPIO PDOR ???? ??1?????????????????????????
        }
    }
}



/*************************************************************************
*                             ???????????????
*
*  ?????????gpio_set
*  ???????????????????
*  ?????????PTxn        ????
*            unsigned short       ????????? 1 ??0
*  ???????????
*  ??????2015-5-15   ?????
*  ??    ???
*************************************************************************/
void gpio_set (PTxn ptxn,unsigned short sata){
  if(sata) GPIO_PDOR_REG(GPIOX[ptxn>> 5])  |= (1 << (ptxn&0x1f));   // GPIO PDOR ???? ??1?????????????????????????
   else    GPIO_PDOR_REG(GPIOX[ptxn>> 5]) &= ~(1 << (ptxn&0x1f));   // GPIO PDOR ???? ??0????????????????????????? 
}
/*************************************************************************
*                             ???????????????
*
*  ?????????gpio_turn
*  ???????????????
*  ?????????PTxn        ????
*  ???????????
*  ??????2015-5-15   ?????
*  ??    ???
*************************************************************************/
void gpio_turn(PTxn ptxn){
  GPIO_PTOR_REG(GPIOX[ptxn>> 5]) |= (1 << (ptxn&0x1f));   // GPIO PTOR ????  
}

/*************************************************************************
*                             ???????????????
*
*  ?????????gpio_get
*  ???????????????
*  ?????????PTxn        ????
*  ???????????
*  ??????2015-5-15   ?????
*  ??    ???
*************************************************************************/
unsigned short gpio_get (PTxn ptxn){
  return ((GPIO_PDIR_REG(GPIOX[ptxn>> 5])>>(ptxn&0x1f)) &0x01);   // GPIO PDIR ????  
}
               
